---
ID: 164
post_title: ecshop生成真静态页html方法
author: chris
post_excerpt: ""
layout: post
permalink: 'http://hss5.com/2013/08/30/ecshop%e7%94%9f%e6%88%90%e7%9c%9f%e9%9d%99%e6%80%81%e9%a1%b5html%e6%96%b9%e6%b3%95/'
published: true
post_date: 2013-08-30 07:57:43
---
<p>ecshop是一个很不错的网店系统，现在很多公司都在用它，它本身优化也很好，不过因为是网店，很多东西都是动态的，所以，对优化来说，不怎么好，不过庆幸的是它可以伪静态。并且有两种重写方法，在后台的商店设置中，可以选择简单重写和复杂重写。<br>　　伪静态已经基本上可以满足大部分人的需求，如果不满足的还可以根据前面的一篇文章对重写规则进行修改，以满足自己的需求。<br>　　但是本文所要描述的是，根据ECSHOP内在的一些代码，我们生成纯静态的网页，使系统更好的优化。<br>　　在这里，我们先对首页进行纯静态生成。<br>　　ECSHOP是一套很好的PHP开源商城系统，但开源产品总是无法符合各个项目的细节需求。负责人要求每个频道页都静态化，以更好的收录，那我就知道利用dedecms建设一系列的封面模板，然后手动去控制产品的缩略图，至于产品列表页，暂时还没静态化，还在考虑怎么静态化比较好，而商城产品内页静态化则使用以下代码。<br>　　Php代码&nbsp;&nbsp; <br>　　if(file_exists($htmlfile) &amp;&amp; (!$updatehtml)){ <br>　　header("HTTP/1.1 301 Moved Permanently"); <br>　　header("Location: {$htmlfile}"); <br>　　}else{ <br>　　$htmlcontent = $smarty-&gt;make_html("goods.dwt",$cache_id); <br>　　if(file_put_contents($htmlfile,$htmlcontent)){ <br>　　header("HTTP/1.1 301 Moved Permanently"); <br>　　header("Location: {$htmlfile}"); <br>　　} <br>　　} <br>　　if(file_exists($htmlfile) &amp;&amp; (!$updatehtml)){ header("HTTP/1.1 301 Moved Permanently"); header("Location: {$htmlfile}"); }else{ $htmlcontent = $smarty-&gt;make_html("goods.dwt",$cache_id); if(file_put_contents($htmlfile,$htmlcontent)){ header("HTTP/1.1 301 Moved Permanently"); header("Location: {$htmlfile}"); } }<br>　　301转向是否能够将收录的地址改变，这个经过实验是可以的，大家可以site一下我的商城就知道。其实这个静态化方法，我的灵感也是来源于supersite,这套开源系统也是经过动态跳转到静态化，收录还不差，所以就模仿着写。<br>　　1.在首页中，$smarty-&gt;display('index.dwt', $cache_id);有这一句，说明是把网页显示出来，现在我们把它改成如下代码（参看注释）<br>　　$file = 'index.html';//静态网页文件名<br>　　$content = $smarty-&gt;make_html('index.dwt');//根据index.dwt模板生成网页内容<br>　　$filename = ROOT_PATH . $file;//静态网页路径<br>　　file_put_contents($filename, $content);//生成文件<br>　　echo $content;//输出到页面<br>　　这几句放在if (!$smarty-&gt;is_cached('index.dwt', $cache_id))判断中这样可以利用原有的判断来决定是不是重新生成静态页面（不过测试了下是一直重新生成的 这个问题有待继续研究）<br>　　//在判断外加上<br>　　//echo file_get_contents(ROOT_PATH . 'index.html');//输出静态页面<br>　　以上几条简单的语句，我们就可以生成首页的静态网页。同理，我们可以生成产品类别和产品的静态网页，整个系统的静态化就完成了。<br>　　首页静态页面生成后，我们接下来要生成的是产品类别的静态页面，我的想法是把产品类别页面保存在跟目录下，这样虽然会比较乱，<br>　　但是比较适合优化，因为一般搜索引擎抓取的时候只抓取二到三层。把产品类别放在根目录，体现产品类别的重要性，易于搜索引擎的<br>　　抓取，另外一方面，我们可以把产品放在下个目录中。<br>　　类似代码：<br>　　$filename = build_uri('category', array('cid' =&gt; $catinfo['cat_id']));//构造路径，这个可以选择自己喜欢的构造方法<br>　　$content = $GLOBALS['smarty']-&gt;make_html('category.dwt');//产生静态页面内容<br>　　$filename = ROOT_PATH . $filename;//生成文件路径，在根目录下<br>　　file_put_contents($filename, $content);//输出<br>　　产品的静态页面代码：<br>　　$goodinfo = get_all_goodsinfo($goods_id);<br>　　$cat_name = $goodinfo['cat_name'];<br>　　$goodsfile = build_uri('goods', array('gid' =&gt; $goods_id));<br>　　$content = $GLOBALS['smarty']-&gt;make_html('goods.dwt');<br>　　$html_tempdir = (ROOT_PATH.$cat_name.'/');<br>　　if (!is_dir($html_tempdir))//生成产品目录<br>　　{<br>　　mkdir($html_tempdir);<br>　　}<br>　　$htmlfilename = ROOT_PATH . $goodsfile;<br>　　file_put_contents($htmlfilename,$content);<br>　　我的是使用类alias.html' target='_blank'&gt;别名称加下划线：<br>　　function build_uri(........)<br>　　................<br>　　case 'category':<br>　　$cat_name = $GLOBALS['db']-&gt;getOne('SELECT cat_name FROM ' . $GLOBALS['ecs']-&gt;table('category') . " WHERE cat_id = '$cid'");<br>　　$uri = $cat_name . '-' . $cid;<br>　　if (!empty($page))<br>　　{<br>　　$uri .= '-' . $page;<br>　　}<br>　　........<br>　　case 'goods':<br>　　$goods_info = $GLOBALS['db']-&gt;getRow('SELECT g.goods_name, c.cat_name FROM ' . $GLOBALS['ecs']-&gt;table('goods') . " as g left join " .<br>　　$GLOBALS['ecs']-&gt;table('category') . " as c on c.cat_id = g.cat_id WHERE g.goods_id = '$gid'");<br>　　$goods_name = $goods_info['goods_name'];<br>　　$cat_name = $cat_name;<br>　　$uri = $cat_name . '/' . $goods_name . '-' . $gid ;<br>　　..........................<br>　　有人问 make_html 这个函数在那里: 我现在补充如下:<br>　　在 includes 下的 cls_template.php 加上<br>　　function make_html($filename, $cache_id = '')<br>　　{<br>　　ob_start();<br>　　$this-&gt;display($filename,$cache_id);<br>　　$out = ob_get_contents();<br>　　ob_end_clean();<br>　　return $out;<br>　　}</p>